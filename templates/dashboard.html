<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Auditoria FB</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Dashboard CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}?v=2.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard-fixes.css') }}?v=1.0">
</head>
<body>
    <!-- Header -->
    <header class="header-clean">
        <div class="header-content">
            <div class="header-left">
                <a href="{{ url_for('dashboard') }}" class="header-brand">
                    <img src="{{ url_for('static', filename='images/logo/logofb_white.png') }}" alt="Logo" class="brand-logo">
                </a>
            </div>
            
            <div class="header-right">
                <!-- Period Filters -->
                <div class="header-filters">
                    <select class="filter-select" id="yearFilter">
                        <option value="">Carregando...</option>
                    </select>
                    
                    <select class="filter-select" id="periodFilter">
                        <option value="month">Mês</option>
                        <option value="q1">1° Trimestre</option>
                        <option value="q2">2° Trimestre</option>
                        <option value="q3">3° Trimestre</option>
                        <option value="q4">4° Trimestre</option>
                        <option value="ytd">Year to Date</option>
                        <option value="full_year">Ano Completo</option>
                        <option value="custom">Período Personalizado</option>
                    </select>
                    
                    <!-- Filtros condicionais para Mês -->
                    <select class="filter-select hidden" id="monthFilter">
                        <option value="">Selecione o mês</option>
                    </select>
                    
                    <select class="filter-select hidden" id="weekFilter">
                        <option value="">Selecione a semana</option>
                    </select>
                    
                    <!-- Advanced Filters Button -->
                    <button class="btn-advanced-filters" id="advancedFiltersBtn">
                        <i class="fas fa-filter"></i>
                        <span class="filter-count" id="filterCount" style="display: none;">0</span>
                    </button>
                </div>
                
                <!-- User Menu -->
                <div class="user-menu">
                    <button class="user-button" id="userMenuToggle">
                        <span>{{ current_user.nome|title }}</span>
                        <div class="user-avatar">
                            {{ current_user.nome[0]|upper }}
                        </div>
                        <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                    </button>
                    
                    <div class="user-dropdown" id="userDropdown">
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-user"></i>
                            <span>Meu Perfil</span>
                        </a>
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-cog"></i>
                            <span>Configurações</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="{{ url_for('logout') }}" class="dropdown-item">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Sair</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <div class="clean-layout">
        <!-- Sidebar with Rail -->
        <aside class="sidebar-clean" id="sidebar">
            <!-- Sidebar Rail -->
            <div class="sidebar-rail">
                <button class="sidebar-toggle" id="sidebarToggle" title="Toggle Sidebar">
                    <i class="fas fa-chevron-left" id="toggleIcon"></i>
                </button>
            </div>
            <div class="sidebar-content">
                <!-- Main Navigation -->
                <nav class="nav-section">
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="{{ url_for('dashboard') }}" class="nav-link active">
                                <i class="fas fa-th-large nav-icon"></i>
                                <span class="nav-text">Dashboard</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="{{ url_for('indicators') }}" class="nav-link">
                                <i class="fas fa-chart-line nav-icon"></i>
                                <span class="nav-text">Indicadores</span>
                            </a>
                        </li>
                    </ul>
                </nav>
                
                <!-- Admin Section -->
                <nav class="nav-admin">
                    <ul class="nav-menu">
                        {% if current_user.perfil in ['admin', 'gestor'] %}
                        <li class="nav-item">
                            <a href="{{ url_for('import_data') }}" class="nav-link">
                                <i class="fas fa-upload nav-icon"></i>
                                <span class="nav-text">Importar Dados</span>
                            </a>
                        </li>
                        {% endif %}
                        {% if current_user.perfil == 'admin' %}
                        <li class="nav-item">
                            <a href="{{ url_for('settings') }}" class="nav-link">
                                <i class="fas fa-cog nav-icon"></i>
                                <span class="nav-text">Configurações</span>
                            </a>
                        </li>
                        {% endif %}
                        <li class="nav-item">
                            <a href="{{ url_for('logout') }}" class="nav-link">
                                <i class="fas fa-sign-out-alt nav-icon"></i>
                                <span class="nav-text">Sair</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-clean">
            <div class="dashboard-content">
                <!-- Page Header with Active Filters -->
                <div class="page-header">
                    <div class="header-wrapper">
                        <div class="title-section">
                            <h1 class="page-title">Dashboard Overview</h1>
                            <p class="page-subtitle">Acompanhamento de métricas e indicadores de performance</p>
                        </div>
                        
                        <!-- Active Filters Display -->
                        <div class="active-filters-display" id="dashboardActiveFilters" style="display: none;">
                            <div class="filters-label">
                                <i class="fas fa-filter"></i>
                                <span>Filtros ativos:</span>
                            </div>
                            <div class="filter-tags" id="dashboardFilterTags">
                                <!-- Filter tags will be dynamically added here -->
                            </div>
                            <button class="clear-filters-btn" onclick="clearAllDashboardFilters()">
                                <i class="fas fa-times"></i>
                                Limpar tudo
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Filters Modal -->
                <div class="modal" id="advancedFiltersModal" style="display: none;">
                    <div class="modal-overlay" onclick="closeAdvancedFilters()"></div>
                    <div class="modal-container">
                        <div class="modal-header">
                            <h2 class="modal-title">Filtros Avançados</h2>
                            <button class="modal-close" onclick="closeAdvancedFilters()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="modal-body">
                            <!-- Active Filters Chips -->
                            <div class="active-filters" id="activeFiltersContainer" style="display: none;">
                                <div class="active-filters-header">
                                    <span class="active-filters-label">Filtros ativos:</span>
                                    <button class="btn-clear-all" onclick="clearAllFilters()">
                                        <i class="fas fa-times"></i> Limpar tudo
                                    </button>
                                </div>
                                <div class="filter-chips" id="filterChips"></div>
                            </div>
                            
                            <!-- Filter Sections -->
                            <div class="filter-sections">
                                <!-- Squad Section -->
                                <div class="filter-section">
                                    <h3 class="section-title">
                                        <i class="fas fa-users"></i> Squad
                                    </h3>
                                    <div class="filter-options" id="squadOptions">
                                        <!-- Options will be populated dynamically -->
                                    </div>
                                </div>
                                
                                <!-- Unit Section -->
                                <div class="filter-section">
                                    <h3 class="section-title">
                                        <i class="fas fa-building"></i> Unidade
                                    </h3>
                                    <div class="filter-options" id="unitOptions">
                                        <!-- Options will be populated dynamically -->
                                    </div>
                                </div>
                                
                                <!-- Category Section -->
                                <div class="filter-section">
                                    <h3 class="section-title">
                                        <i class="fas fa-tags"></i> Categoria de Produto
                                    </h3>
                                    <div class="filter-options" id="categoryOptions">
                                        <!-- Options will be populated dynamically -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="clearAllFilters()">
                                <i class="fas fa-eraser"></i> Limpar Filtros
                            </button>
                            <button class="btn-primary" onclick="applyAdvancedFilters()">
                                <i class="fas fa-check"></i> Aplicar Filtros
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Período Personalizado Modal -->
                <div class="modal" id="customPeriodModal" style="display: none;">
                    <div class="custom-period-container">
                        <div class="custom-period-header">
                            <div class="period-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <h3 class="period-title">Período Personalizado</h3>
                            <button class="period-close" onclick="closeCustomPeriod()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="custom-period-body">
                            <p class="period-description">Selecione o intervalo de datas para análise</p>
                            
                            <div class="date-input-group">
                                <div class="date-field">
                                    <label class="date-label">
                                        <i class="fas fa-calendar-day"></i>
                                        Data Inicial
                                    </label>
                                    <input type="date" id="startDate" class="date-input">
                                </div>
                                
                                <div class="date-separator">
                                    <i class="fas fa-arrow-right"></i>
                                </div>
                                
                                <div class="date-field">
                                    <label class="date-label">
                                        <i class="fas fa-calendar-check"></i>
                                        Data Final
                                    </label>
                                    <input type="date" id="endDate" class="date-input">
                                </div>
                            </div>
                            
                            <div class="period-suggestions">
                                <p class="suggestions-label">Sugestões rápidas:</p>
                                <div class="suggestion-chips">
                                    <button class="suggestion-chip" onclick="setPeriodSuggestion('last7days')">
                                        Últimos 7 dias
                                    </button>
                                    <button class="suggestion-chip" onclick="setPeriodSuggestion('last30days')">
                                        Últimos 30 dias
                                    </button>
                                    <button class="suggestion-chip" onclick="setPeriodSuggestion('last90days')">
                                        Últimos 90 dias
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="custom-period-footer">
                            <button class="btn-period-cancel" onclick="closeCustomPeriod()">
                                <i class="fas fa-times"></i>
                                Cancelar
                            </button>
                            <button class="btn-period-confirm" onclick="confirmCustomPeriod()">
                                <i class="fas fa-check"></i>
                                Aplicar Período
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Metrics Grid - 4 Cards Principais -->
                <div class="metrics-grid">
                    <!-- Produtos Vendidos -->
                    <div class="metric-card">
                        <div class="metric-content">
                            <div class="metric-header">
                                <div class="metric-info">
                                    <p class="metric-title">Produtos Vendidos</p>
                                    <h2 class="metric-value" id="produtosVendidos">R$ 0</h2>
                                    <div class="metric-stats">
                                        <div class="metric-stat">
                                            <span class="stat-label">Faturamento Total</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric-badge">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cancelamentos -->
                    <div class="metric-card">
                        <div class="metric-content">
                            <div class="metric-header">
                                <div class="metric-info">
                                    <p class="metric-title">Cancelamentos</p>
                                    <h2 class="metric-value" id="cancelamentos">R$ 0</h2>
                                    <div class="metric-stats">
                                        <div class="metric-stat">
                                            <span class="stat-label">Índice:</span>
                                            <span class="stat-value" id="indiceCancelamento">0%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric-badge" style="background: #ff6b6b;">
                                    <i class="fas fa-times-circle"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Estornos -->
                    <div class="metric-card">
                        <div class="metric-content">
                            <div class="metric-header">
                                <div class="metric-info">
                                    <p class="metric-title">Estornos</p>
                                    <h2 class="metric-value" id="estornos">R$ 0</h2>
                                    <div class="metric-stats">
                                        <div class="metric-stat">
                                            <span class="stat-label">Índice:</span>
                                            <span class="stat-value" id="indiceEstorno">0%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric-badge" style="background: #fd7e14;">
                                    <i class="fas fa-undo"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Estornos + Cancelamentos -->
                    <div class="metric-card">
                        <div class="metric-content">
                            <div class="metric-header">
                                <div class="metric-info">
                                    <p class="metric-title">Estornos + Cancelamentos</p>
                                    <h2 class="metric-value" id="estornosCancelamentos">R$ 0</h2>
                                    <div class="metric-stats">
                                        <div class="metric-stat">
                                            <span class="stat-label">Total Combinado</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric-badge" style="background: #6c757d;">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Section -->
                <div class="chart-grid">
                    <!-- Main Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div>
                                <h3 class="chart-title">Evolução do Faturamento</h3>
                                <p class="chart-subtitle">Análise comparativa do período selecionado</p>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="mainChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Índices Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Índices de Cancelamento e Estorno</h3>
                        </div>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="indicesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/formatters.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sidebar-toggle.js') }}"></script>
    
    <style>
    .hidden {
        display: none !important;
    }
    </style>
    
    <script>
    // Variáveis globais
    let currentFilters = {
        ano: null,
        mes: null,
        semana: null,
        unidade: null,
        squad: null,
        categoria: null,
        data_inicio: null,
        data_fim: null
    };
    
    // Função para capitalizar texto
    function capitalizeText(text) {
        if (!text) return text;
        return text.toLowerCase().split(' ').map(word => 
            word.charAt(0).toUpperCase() + word.slice(1)
        ).join(' ');
    }
    
    // Sidebar Toggle
    document.getElementById('sidebarToggle').addEventListener('click', function() {
        document.getElementById('sidebar').classList.toggle('collapsed');
    });
    
    // User Menu Toggle
    document.getElementById('userMenuToggle').addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('userDropdown').classList.toggle('show');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function() {
        document.getElementById('userDropdown').classList.remove('show');
    });
    
    // Period filter change handler
    document.getElementById('periodFilter').addEventListener('change', function() {
        const value = this.value;
        const monthFilter = document.getElementById('monthFilter');
        const weekFilter = document.getElementById('weekFilter');
        
        if (value === 'month') {
            monthFilter.classList.remove('hidden');
            weekFilter.classList.remove('hidden');
        } else {
            monthFilter.classList.add('hidden');
            weekFilter.classList.add('hidden');
            
            if (value === 'custom') {
                document.getElementById('customPeriodModal').style.display = 'flex';
            }
        }
        
        updateFiltersBasedOnPeriod();
        updateCurrentFilters();
        loadDashboardData();
    });
    
    // Month filter change handler
    document.getElementById('monthFilter').addEventListener('change', function() {
        if (this.value) {
            loadWeeksForMonth();
        }
        updateCurrentFilters();
        loadDashboardData();
    });
    
    // Auto-apply period filters on change
    document.getElementById('yearFilter').addEventListener('change', function() {
        updateCurrentFilters();
        loadDashboardData();
    });
    
    // Advanced filters button
    document.getElementById('advancedFiltersBtn').addEventListener('click', function() {
        openAdvancedFilters();
    });
    
    // Advanced filters state
    let advancedFilters = {
        squads: [],
        units: [],
        categories: []
    };
    
    // Toggle Sidebar - movido para dentro do DOMContentLoaded
    function initializeSidebarToggle() {
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const toggleIcon = document.getElementById('toggleIcon');
        const mainContent = document.querySelector('.main-clean');
    
    // Load sidebar state from localStorage
    const savedSidebarState = localStorage.getItem('sidebarCollapsed');
    if (savedSidebarState === 'true') {
        sidebar.classList.add('collapsed');
    }
    
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Toggle clicked!');
                
                sidebar.classList.toggle('collapsed');
                
                // Save state to localStorage
                localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
                
                // Add tooltips when collapsed
                if (sidebar.classList.contains('collapsed')) {
                    addSidebarTooltips();
                } else {
                    removeSidebarTooltips();
                }
            });
        } else {
            console.error('Sidebar toggle button not found!');
        }
    
    // Tooltip functions
    function addSidebarTooltips() {
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
            const text = link.querySelector('.nav-text').textContent;
            link.setAttribute('title', text);
        });
    }
    
    function removeSidebarTooltips() {
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
            link.removeAttribute('title');
        });
    }
    
        // Initialize tooltips if sidebar is already collapsed
        if (sidebar.classList.contains('collapsed')) {
            addSidebarTooltips();
        }
    }
    
    // Custom period functions
    function closeCustomPeriod() {
        document.getElementById('customPeriodModal').style.display = 'none';
        // Don't change the period filter value when closing
    }
    
    function confirmCustomPeriod() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        if (startDate && endDate) {
            currentFilters.data_inicio = startDate;
            currentFilters.data_fim = endDate;
            document.getElementById('customPeriodModal').style.display = 'none';
            updateCurrentFilters();
            loadDashboardData();
        }
    }
    
    // Update filters based on period selection
    function updateFiltersBasedOnPeriod() {
        const year = parseInt(document.getElementById('yearFilter').value);
        const period = document.getElementById('periodFilter').value;
        const month = document.getElementById('monthFilter').value;
        
        // Reset all date-related filters
        currentFilters.data_inicio = null;
        currentFilters.data_fim = null;
        currentFilters.mes = null;
        currentFilters.semana = null;
        
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth() + 1;
        
        switch(period) {
            case 'q1':
                currentFilters.data_inicio = `${year}-01-01`;
                currentFilters.data_fim = `${year}-03-31`;
                break;
            case 'q2':
                currentFilters.data_inicio = `${year}-04-01`;
                currentFilters.data_fim = `${year}-06-30`;
                break;
            case 'q3':
                currentFilters.data_inicio = `${year}-07-01`;
                currentFilters.data_fim = `${year}-09-30`;
                break;
            case 'q4':
                currentFilters.data_inicio = `${year}-10-01`;
                currentFilters.data_fim = `${year}-12-31`;
                break;
            case 'ytd':
                currentFilters.data_inicio = `${year}-01-01`;
                if (year === currentYear) {
                    currentFilters.data_fim = today.toISOString().split('T')[0];
                } else {
                    currentFilters.data_fim = `${year}-12-31`;
                }
                break;
            case 'full_year':
                currentFilters.data_inicio = `${year}-01-01`;
                currentFilters.data_fim = `${year}-12-31`;
                break;
            case 'month':
                if (month) {
                    currentFilters.mes = parseInt(month);
                    currentFilters.ano = year;
                    // Clear date range filters when using month
                    currentFilters.data_inicio = null;
                    currentFilters.data_fim = null;
                }
                break;
            case 'custom':
                // Custom period dates are set in confirmCustomPeriod function
                break;
        }
    }
    
    // Update current filters from UI
    function updateCurrentFilters() {
        currentFilters.ano = parseInt(document.getElementById('yearFilter').value);
        currentFilters.unidade = advancedFilters.units.length > 0 ? advancedFilters.units.join(',') : null;
        currentFilters.squad = advancedFilters.squads.length > 0 ? advancedFilters.squads.join(',') : null;
        currentFilters.categoria = advancedFilters.categories.length > 0 ? advancedFilters.categories.join(',') : null;
        
        const period = document.getElementById('periodFilter').value;
        if (period === 'month') {
            currentFilters.mes = parseInt(document.getElementById('monthFilter').value) || null;
            
            const weekData = document.getElementById('weekFilter').value;
            if (weekData) {
                currentFilters.semana = weekData;
            } else {
                currentFilters.semana = null;
            }
        }
        
        updateFiltersBasedOnPeriod();
    }
    
    // Load filter options
    async function loadFilterOptions() {
        return new Promise(async (resolve, reject) => {
            try {
                const response = await fetch('/api/dashboard/filters');
                const data = await response.json();
            
            // Populate year filter
            const yearFilter = document.getElementById('yearFilter');
            yearFilter.innerHTML = '';
            data.anos.forEach(ano => {
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                if (ano === new Date().getFullYear()) {
                    option.selected = true;
                }
                yearFilter.appendChild(option);
            });
            
            // Populate month filter
            const monthFilter = document.getElementById('monthFilter');
            monthFilter.innerHTML = '<option value="">Selecione o mês</option>';
            data.meses.forEach(mes => {
                const option = document.createElement('option');
                option.value = mes.valor;
                option.textContent = mes.nome;
                if (mes.valor === new Date().getMonth() + 1) {
                    option.selected = true;
                }
                monthFilter.appendChild(option);
            });
            
            // Store filter options for modal
            window.filterData = {
                squads: data.squads,
                units: data.unidades,
                categories: data.categorias
            };
            
            // Populate filter modal options
            populateFilterModal();
            
            // Set initial period to Year to Date
            document.getElementById('periodFilter').value = 'ytd';
            
            // Update filters based on YTD selection
            updateFiltersBasedOnPeriod();
            
            // Adjust select widths after loading
            setTimeout(() => {
                document.querySelectorAll('.filter-select').forEach(select => {
                    adjustSelectWidth(select);
                });
            }, 100);
            
            resolve();
            } catch (error) {
                console.error('Erro ao carregar filtros:', error);
                reject(error);
            }
        });
    }
    
    // Load weeks for selected month
    async function loadWeeksForMonth() {
        const ano = document.getElementById('yearFilter').value;
        const mes = document.getElementById('monthFilter').value;
        
        if (!ano || !mes) return;
        
        try {
            const response = await fetch(`/api/dashboard/semanas?ano=${ano}&mes=${mes}`);
            const data = await response.json();
            
            const weekFilter = document.getElementById('weekFilter');
            weekFilter.innerHTML = '<option value="">Todas as semanas</option>';
            
            data.semanas.forEach(semana => {
                const option = document.createElement('option');
                option.value = semana.data;
                option.textContent = semana.label;
                weekFilter.appendChild(option);
            });
            
            // Add event listener to week filter
            weekFilter.addEventListener('change', function() {
                updateCurrentFilters();
                loadDashboardData();
            }, { once: true });
            
        } catch (error) {
            console.error('Erro ao carregar semanas:', error);
        }
    }
    
    // Load dashboard data
    async function loadDashboardData() {
        try {
            // Build query params
            const params = new URLSearchParams();
            Object.keys(currentFilters).forEach(key => {
                if (currentFilters[key] !== null && currentFilters[key] !== '') {
                    params.append(key, currentFilters[key]);
                }
            });
            
            const response = await fetch(`/api/dashboard/summary?${params}`);
            const data = await response.json();
            
            // Update cards
            document.getElementById('produtosVendidos').textContent = data.produtos_vendidos.formatado;
            document.getElementById('cancelamentos').textContent = data.cancelamentos.formatado;
            document.getElementById('estornos').textContent = data.estornos.formatado;
            document.getElementById('estornosCancelamentos').textContent = data.estornos_cancelamentos.formatado;
            
            // Update indices
            document.getElementById('indiceCancelamento').textContent = data.indice_cancelamento + '%';
            document.getElementById('indiceEstorno').textContent = data.indice_estorno + '%';
            
            // Update charts
            updateCharts(data);
            
        } catch (error) {
            console.error('Erro ao carregar dados:', error);
        }
    }
    
    // Update charts
    function updateCharts(data) {
        // Main chart - to be implemented
        // Indices chart - to be implemented
    }
    
    // Advanced Filter Modal Functions
    function openAdvancedFilters() {
        const modal = document.getElementById('advancedFiltersModal');
        modal.style.display = 'flex';
        // Force reflow to ensure animation plays
        modal.offsetHeight;
        modal.classList.add('modal-open');
        document.body.style.overflow = 'hidden';
    }
    
    function closeAdvancedFilters() {
        const modal = document.getElementById('advancedFiltersModal');
        modal.classList.remove('modal-open');
        setTimeout(() => {
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }, 300);
    }
    
    function populateFilterModal() {
        if (!window.filterData) return;
        
        // Populate squad options
        const squadContainer = document.getElementById('squadOptions');
        squadContainer.innerHTML = '';
        window.filterData.squads.forEach(squad => {
            const label = createFilterOption('squad', squad, capitalizeText(squad));
            squadContainer.appendChild(label);
        });
        
        // Populate unit options
        const unitContainer = document.getElementById('unitOptions');
        unitContainer.innerHTML = '';
        window.filterData.units.forEach(unit => {
            const label = createFilterOption('unit', unit, capitalizeText(unit));
            unitContainer.appendChild(label);
        });
        
        // Populate category options
        const categoryContainer = document.getElementById('categoryOptions');
        categoryContainer.innerHTML = '';
        window.filterData.categories.forEach(category => {
            const label = createFilterOption('category', category, capitalizeText(category));
            categoryContainer.appendChild(label);
        });
    }
    
    function createFilterOption(type, value, displayText) {
        const label = document.createElement('label');
        label.className = 'filter-option';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = value;
        checkbox.className = 'filter-checkbox';
        checkbox.id = `${type}_${value}`;
        
        // Check if already selected
        if ((type === 'squad' && advancedFilters.squads.includes(value)) ||
            (type === 'unit' && advancedFilters.units.includes(value)) ||
            (type === 'category' && advancedFilters.categories.includes(value))) {
            checkbox.checked = true;
        }
        
        checkbox.addEventListener('change', function() {
            updateFilterSelection(type, value, this.checked);
        });
        
        const span = document.createElement('span');
        span.textContent = displayText;
        
        label.appendChild(checkbox);
        label.appendChild(span);
        
        return label;
    }
    
    function updateFilterSelection(type, value, isChecked) {
        let arrayRef;
        if (type === 'squad') arrayRef = advancedFilters.squads;
        else if (type === 'unit') arrayRef = advancedFilters.units;
        else if (type === 'category') arrayRef = advancedFilters.categories;
        
        if (isChecked) {
            if (!arrayRef.includes(value)) {
                arrayRef.push(value);
            }
        } else {
            const index = arrayRef.indexOf(value);
            if (index > -1) {
                arrayRef.splice(index, 1);
            }
        }
        
        updateFilterChips();
        updateFilterCount();
    }
    
    function updateFilterChips() {
        const container = document.getElementById('filterChips');
        container.innerHTML = '';
        
        let hasFilters = false;
        
        // Add squad chips
        advancedFilters.squads.forEach(squad => {
            container.appendChild(createFilterChip('squad', squad, capitalizeText(squad)));
            hasFilters = true;
        });
        
        // Add unit chips
        advancedFilters.units.forEach(unit => {
            container.appendChild(createFilterChip('unit', unit, capitalizeText(unit)));
            hasFilters = true;
        });
        
        // Add category chips
        advancedFilters.categories.forEach(category => {
            container.appendChild(createFilterChip('category', category, capitalizeText(category)));
            hasFilters = true;
        });
        
        // Show/hide active filters section
        document.getElementById('activeFiltersContainer').style.display = hasFilters ? 'block' : 'none';
    }
    
    function createFilterChip(type, value, displayText) {
        const chip = document.createElement('div');
        chip.className = 'filter-chip';
        
        const text = document.createElement('span');
        text.textContent = displayText;
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'chip-remove';
        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
        removeBtn.onclick = function() {
            removeFilter(type, value);
        };
        
        chip.appendChild(text);
        chip.appendChild(removeBtn);
        
        return chip;
    }
    
    function removeFilter(type, value) {
        updateFilterSelection(type, value, false);
        const checkbox = document.getElementById(`${type}_${value}`);
        if (checkbox) checkbox.checked = false;
    }
    
    function clearAllFilters() {
        advancedFilters.squads = [];
        advancedFilters.units = [];
        advancedFilters.categories = [];
        
        // Uncheck all checkboxes
        document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        updateFilterChips();
        updateFilterCount();
        
        // Update current filters and reload data
        updateCurrentFilters();
        loadDashboardData();
    }
    
    function applyAdvancedFilters() {
        updateCurrentFilters();
        loadDashboardData();
        updateDashboardFilterTags();
        closeAdvancedFilters();
    }
    
    // Dashboard Active Filters Display
    function updateDashboardFilterTags() {
        const container = document.getElementById('dashboardFilterTags');
        const displayContainer = document.getElementById('dashboardActiveFilters');
        container.innerHTML = '';
        
        let allTags = [];
        let hasFilters = false;
        
        // Collect all tags
        advancedFilters.squads.forEach(squad => {
            allTags.push({ type: 'squad', label: 'Squad', value: squad, display: capitalizeText(squad) });
            hasFilters = true;
        });
        
        advancedFilters.units.forEach(unit => {
            allTags.push({ type: 'unit', label: 'Unidade', value: unit, display: capitalizeText(unit) });
            hasFilters = true;
        });
        
        advancedFilters.categories.forEach(category => {
            allTags.push({ type: 'category', label: 'Categoria', value: category, display: capitalizeText(category) });
            hasFilters = true;
        });
        
        // Calculate how many tags can be displayed
        const maxVisibleTags = 5;
        const visibleTags = allTags.slice(0, maxVisibleTags);
        const hiddenCount = allTags.length - maxVisibleTags;
        
        // Add visible tags
        visibleTags.forEach(tag => {
            container.appendChild(createDashboardFilterTag(tag.label, tag.value, tag.display, tag.type));
        });
        
        // Add "more" indicator if needed
        if (hiddenCount > 0) {
            const moreIndicator = document.createElement('div');
            moreIndicator.className = 'more-filters-indicator';
            moreIndicator.textContent = `+${hiddenCount}`;
            moreIndicator.title = 'Clique para ver todos os filtros';
            moreIndicator.onclick = function() {
                openAdvancedFilters();
            };
            container.appendChild(moreIndicator);
        }
        
        // Show/hide active filters section
        displayContainer.style.display = hasFilters ? 'flex' : 'none';
    }
    
    function createDashboardFilterTag(label, value, displayText, type) {
        const tag = document.createElement('div');
        tag.className = 'filter-tag';
        
        const tagLabel = document.createElement('span');
        tagLabel.className = 'tag-label';
        tagLabel.textContent = label + ':';
        
        const tagValue = document.createElement('span');
        tagValue.className = 'tag-value';
        tagValue.textContent = displayText;
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'tag-remove';
        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
        removeBtn.onclick = function(e) {
            e.stopPropagation();
            removeFilter(type, value);
            updateDashboardFilterTags();
        };
        
        tag.appendChild(tagLabel);
        tag.appendChild(tagValue);
        tag.appendChild(removeBtn);
        
        return tag;
    }
    
    function clearAllDashboardFilters() {
        clearAllFilters();
        updateDashboardFilterTags();
    }
    
    function updateFilterCount() {
        const totalFilters = advancedFilters.squads.length + 
                           advancedFilters.units.length + 
                           advancedFilters.categories.length;
        
        const countElement = document.getElementById('filterCount');
        if (totalFilters > 0) {
            countElement.textContent = totalFilters;
            countElement.style.display = 'inline-flex';
        } else {
            countElement.style.display = 'none';
        }
    }
    
    // Period suggestion function
    function setPeriodSuggestion(suggestion) {
        const today = new Date();
        let startDate, endDate;
        
        switch(suggestion) {
            case 'last7days':
                startDate = new Date(today);
                startDate.setDate(today.getDate() - 7);
                endDate = today;
                break;
            case 'last30days':
                startDate = new Date(today);
                startDate.setDate(today.getDate() - 30);
                endDate = today;
                break;
            case 'last90days':
                startDate = new Date(today);
                startDate.setDate(today.getDate() - 90);
                endDate = today;
                break;
        }
        
        document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
    }
    
    // Adjust select width based on content
    function adjustSelectWidth(selectElement) {
        // Create a temporary span to measure text width
        const tempSpan = document.createElement('span');
        tempSpan.style.position = 'absolute';
        tempSpan.style.visibility = 'hidden';
        tempSpan.style.fontSize = window.getComputedStyle(selectElement).fontSize;
        tempSpan.style.fontFamily = window.getComputedStyle(selectElement).fontFamily;
        tempSpan.style.padding = '0 2.5rem 0 1rem'; // Account for padding and arrow
        
        // Get selected option text
        const selectedText = selectElement.options[selectElement.selectedIndex].text;
        tempSpan.textContent = selectedText;
        
        document.body.appendChild(tempSpan);
        const textWidth = tempSpan.offsetWidth;
        document.body.removeChild(tempSpan);
        
        // Set the width with some extra space
        selectElement.style.width = (textWidth + 20) + 'px';
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadFilterOptions().then(() => {
            // Set initial filters after options are loaded
            updateCurrentFilters();
            
            // Load initial data
            loadDashboardData();
            
            // Initialize dashboard filter tags
            updateDashboardFilterTags();
            
            // Initialize sidebar toggle
            initializeSidebarToggle();
            
            // Adjust select widths
            document.querySelectorAll('.filter-select').forEach(select => {
                adjustSelectWidth(select);
                select.addEventListener('change', function() {
                    adjustSelectWidth(this);
                });
            });
        });
    });
    </script>
</body>
</html>