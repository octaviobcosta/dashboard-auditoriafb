{% extends "base_modern.html" %}

{% block title %}Indicadores - Dashboard Auditoria FB{% endblock %}

{% block extra_css %}
<style>
    .kpi-card {
        position: relative;
        overflow: hidden;
    }
    
    .kpi-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, var(--primary), transparent);
        opacity: 0.05;
        animation: rotate 20s linear infinite;
    }
    
    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .trend-chart {
        height: 60px;
        margin: 16px 0;
    }
    
    .comparison-bar {
        position: relative;
        height: 40px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        overflow: hidden;
        margin: 8px 0;
    }
    
    .comparison-fill {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding: 0 12px;
        font-weight: 700;
        font-size: 0.875rem;
        transition: width 1s ease-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div style="margin-bottom: 32px;">
        <h1 style="font-size: 1.875rem; font-weight: 800; margin: 0 0 8px 0;">Indicadores de Performance</h1>
        <p style="opacity: 0.6;">Análise detalhada dos KPIs e métricas de desempenho</p>
    </div>
    
    <!-- Filter Section -->
    <div style="display: flex; gap: 16px; margin-bottom: 32px;">
        <select class="btn-modern ghost" style="min-width: 200px;">
            <option>Todas as Unidades</option>
            <option>BB Centro</option>
            <option>Blue Note</option>
            <option>BB Granja</option>
        </select>
        <select class="btn-modern ghost" style="min-width: 150px;">
            <option>Último Mês</option>
            <option>Últimos 3 Meses</option>
            <option>Último Ano</option>
        </select>
        <button class="btn-modern primary" style="margin-left: auto;">
            <i class="fas fa-download" style="margin-right: 8px;"></i>
            Exportar Relatório
        </button>
    </div>
    
    <!-- Main KPIs -->
    <div class="dashboard-grid" style="margin-bottom: 32px;">
        <!-- Margem de Lucro -->
        <div class="col-span-3">
            <div class="card-modern kpi-card glass" style="padding: 32px;">
                <div style="display: flex; align-items: start; justify-content: space-between;">
                    <div>
                        <p class="metric-label">MARGEM DE LUCRO</p>
                        <h2 style="font-size: 3rem; font-weight: 800; margin: 16px 0; color: var(--success);">
                            18.5<span style="font-size: 1.5rem;">%</span>
                        </h2>
                        <div class="metric-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>+2.3pp</span>
                        </div>
                    </div>
                    <div style="width: 100px; height: 100px;">
                        <svg viewBox="0 0 36 36" style="transform: rotate(-90deg);">
                            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                fill="none"
                                stroke="rgba(255,255,255,0.1)"
                                stroke-width="3"/>
                            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                fill="none"
                                stroke="var(--success)"
                                stroke-width="3"
                                stroke-dasharray="18.5, 100"
                                stroke-linecap="round"/>
                        </svg>
                    </div>
                </div>
                <canvas id="profitTrend" class="trend-chart"></canvas>
            </div>
        </div>
        
        <!-- Taxa de Cancelamento -->
        <div class="col-span-3">
            <div class="card-modern kpi-card glass" style="padding: 32px;">
                <div style="display: flex; align-items: start; justify-content: space-between;">
                    <div>
                        <p class="metric-label">TAXA DE CANCELAMENTO</p>
                        <h2 style="font-size: 3rem; font-weight: 800; margin: 16px 0; color: var(--danger);">
                            1.85<span style="font-size: 1.5rem;">%</span>
                        </h2>
                        <div class="metric-change negative">
                            <i class="fas fa-arrow-up"></i>
                            <span>+0.12pp</span>
                        </div>
                    </div>
                    <div style="width: 100px; height: 100px;">
                        <svg viewBox="0 0 36 36" style="transform: rotate(-90deg);">
                            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                fill="none"
                                stroke="rgba(255,255,255,0.1)"
                                stroke-width="3"/>
                            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                fill="none"
                                stroke="var(--danger)"
                                stroke-width="3"
                                stroke-dasharray="1.85, 100"
                                stroke-linecap="round"/>
                        </svg>
                    </div>
                </div>
                <canvas id="cancelTrend" class="trend-chart"></canvas>
            </div>
        </div>
        
        <!-- Taxa de Estorno -->
        <div class="col-span-3">
            <div class="card-modern kpi-card glass" style="padding: 32px;">
                <div style="display: flex; align-items: start; justify-content: space-between;">
                    <div>
                        <p class="metric-label">TAXA DE ESTORNO</p>
                        <h2 style="font-size: 3rem; font-weight: 800; margin: 16px 0; color: var(--warning);">
                            0.44<span style="font-size: 1.5rem;">%</span>
                        </h2>
                        <div class="metric-change positive">
                            <i class="fas fa-arrow-down"></i>
                            <span>-0.05pp</span>
                        </div>
                    </div>
                    <div style="width: 100px; height: 100px;">
                        <svg viewBox="0 0 36 36" style="transform: rotate(-90deg);">
                            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                fill="none"
                                stroke="rgba(255,255,255,0.1)"
                                stroke-width="3"/>
                            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                fill="none"
                                stroke="var(--warning)"
                                stroke-width="3"
                                stroke-dasharray="0.44, 100"
                                stroke-linecap="round"/>
                        </svg>
                    </div>
                </div>
                <canvas id="refundTrend" class="trend-chart"></canvas>
            </div>
        </div>
        
        <!-- Crescimento MoM -->
        <div class="col-span-3">
            <div class="card-modern kpi-card glass" style="padding: 32px;">
                <div style="display: flex; align-items: start; justify-content: space-between;">
                    <div>
                        <p class="metric-label">CRESCIMENTO MOM</p>
                        <h2 style="font-size: 3rem; font-weight: 800; margin: 16px 0; color: var(--primary);">
                            12.8<span style="font-size: 1.5rem;">%</span>
                        </h2>
                        <div class="metric-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>+3.2pp</span>
                        </div>
                    </div>
                    <div style="width: 100px; height: 100px;">
                        <svg viewBox="0 0 36 36" style="transform: rotate(-90deg);">
                            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                fill="none"
                                stroke="rgba(255,255,255,0.1)"
                                stroke-width="3"/>
                            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                fill="none"
                                stroke="var(--primary)"
                                stroke-width="3"
                                stroke-dasharray="12.8, 100"
                                stroke-linecap="round"/>
                        </svg>
                    </div>
                </div>
                <canvas id="growthTrend" class="trend-chart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Detailed Analysis -->
    <div class="dashboard-grid" style="margin-bottom: 32px;">
        <!-- Breakdown por Motivo -->
        <div class="col-span-6">
            <div class="card-modern glass" style="padding: 32px;">
                <h3 style="font-size: 1.25rem; font-weight: 700; margin: 0 0 24px 0;">Análise de Cancelamentos</h3>
                <div style="height: 300px;">
                    <canvas id="cancelReasonsChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Performance Comparativa -->
        <div class="col-span-6">
            <div class="card-modern glass" style="padding: 32px;">
                <h3 style="font-size: 1.25rem; font-weight: 700; margin: 0 0 24px 0;">Performance por Unidade</h3>
                
                <div style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: 600;">BB Centro</span>
                        <span style="font-weight: 700; color: var(--success);">22.5%</span>
                    </div>
                    <div class="comparison-bar">
                        <div class="comparison-fill" style="width: 90%; background: linear-gradient(90deg, var(--success), var(--primary));">
                            <span>Margem: 22.5%</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: 600;">Blue Note</span>
                        <span style="font-weight: 700; color: var(--warning);">18.3%</span>
                    </div>
                    <div class="comparison-bar">
                        <div class="comparison-fill" style="width: 73%; background: linear-gradient(90deg, var(--warning), var(--primary));">
                            <span>Margem: 18.3%</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: 600;">BB Granja</span>
                        <span style="font-weight: 700; color: var(--warning);">16.8%</span>
                    </div>
                    <div class="comparison-bar">
                        <div class="comparison-fill" style="width: 67%; background: linear-gradient(90deg, var(--warning), var(--danger));">
                            <span>Margem: 16.8%</span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: 600;">Arcos</span>
                        <span style="font-weight: 700; color: var(--danger);">14.2%</span>
                    </div>
                    <div class="comparison-bar">
                        <div class="comparison-fill" style="width: 57%; background: linear-gradient(90deg, var(--danger), var(--info));">
                            <span>Margem: 14.2%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Trend Analysis -->
    <div class="card-modern glass" style="padding: 32px;">
        <h3 style="font-size: 1.25rem; font-weight: 700; margin: 0 0 24px 0;">Evolução Temporal dos Indicadores</h3>
        <div style="height: 350px;">
            <canvas id="indicatorsTrendChart"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Mini trend charts
function drawTrendChart(canvasId, data, color) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    // Create gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, height);
    gradient.addColorStop(0, color + '40');
    gradient.addColorStop(1, color + '00');
    
    // Scale data
    const max = Math.max(...data);
    const min = Math.min(...data);
    const range = max - min;
    const step = width / (data.length - 1);
    
    // Draw area
    ctx.beginPath();
    data.forEach((value, index) => {
        const x = index * step;
        const y = height - ((value - min) / range) * (height - 10);
        
        if (index === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });
    
    ctx.lineTo(width, height);
    ctx.lineTo(0, height);
    ctx.closePath();
    ctx.fillStyle = gradient;
    ctx.fill();
    
    // Draw line
    ctx.beginPath();
    data.forEach((value, index) => {
        const x = index * step;
        const y = height - ((value - min) / range) * (height - 10);
        
        if (index === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });
    
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.stroke();
}

// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    // Draw trend charts
    drawTrendChart('profitTrend', [15.2, 16.8, 17.3, 16.9, 18.1, 18.5, 18.3, 18.5], '#00FF88');
    drawTrendChart('cancelTrend', [2.1, 1.95, 1.87, 1.92, 1.88, 1.85, 1.87, 1.85], '#FF3366');
    drawTrendChart('refundTrend', [0.52, 0.48, 0.45, 0.47, 0.43, 0.44, 0.42, 0.44], '#FFB800');
    drawTrendChart('growthTrend', [8.5, 9.2, 10.1, 11.3, 12.5, 12.8, 12.6, 12.8], '#00D4FF');
    
    // Cancellation Reasons Chart
    const cancelCtx = document.getElementById('cancelReasonsChart').getContext('2d');
    new Chart(cancelCtx, {
        type: 'polarArea',
        data: {
            labels: ['Remoção de Couvert', 'Troca de Produto', 'Erro de Lançamento', 'Desistência', 'Produto Indisponível'],
            datasets: [{
                data: [28.7, 24.3, 19.5, 13.2, 9.1],
                backgroundColor: [
                    'rgba(0, 212, 255, 0.7)',
                    'rgba(0, 255, 136, 0.7)',
                    'rgba(255, 184, 0, 0.7)',
                    'rgba(255, 51, 102, 0.7)',
                    'rgba(123, 97, 255, 0.7)'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: 'rgba(255, 255, 255, 0.8)',
                        padding: 16,
                        font: { size: 11 }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed + '%';
                        }
                    }
                }
            },
            scales: {
                r: {
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: { display: false }
                }
            }
        }
    });
    
    // Indicators Trend Chart
    const trendCtx = document.getElementById('indicatorsTrendChart').getContext('2d');
    new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago'],
            datasets: [{
                label: 'Margem de Lucro',
                data: [15.2, 16.8, 17.3, 16.9, 18.1, 18.5, 18.3, 18.5],
                borderColor: '#00FF88',
                backgroundColor: 'rgba(0, 255, 136, 0.1)',
                tension: 0.4,
                borderWidth: 3
            }, {
                label: 'Taxa de Cancelamento',
                data: [2.1, 1.95, 1.87, 1.92, 1.88, 1.85, 1.87, 1.85],
                borderColor: '#FF3366',
                backgroundColor: 'rgba(255, 51, 102, 0.1)',
                tension: 0.4,
                borderWidth: 3
            }, {
                label: 'Taxa de Estorno',
                data: [0.52, 0.48, 0.45, 0.47, 0.43, 0.44, 0.42, 0.44],
                borderColor: '#FFB800',
                backgroundColor: 'rgba(255, 184, 0, 0.1)',
                tension: 0.4,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    labels: {
                        color: 'rgba(255, 255, 255, 0.8)',
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + '%';
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: { color: 'rgba(255, 255, 255, 0.6)' }
                },
                y: {
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: { 
                        color: 'rgba(255, 255, 255, 0.6)',
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
    
    // Animate comparison bars
    setTimeout(() => {
        document.querySelectorAll('.comparison-fill').forEach((bar, index) => {
            const width = bar.style.width;
            bar.style.width = '0';
            setTimeout(() => {
                bar.style.width = width;
            }, index * 200);
        });
    }, 500);
});
</script>
{% endblock %}